name: ğŸš€ Build, Push & Deploy to VPS with Ansible

on:
  push:
    branches:
      - master

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Cloner le dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ğŸ”‘ Se connecter Ã  GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin

      - name: ğŸ—ï¸ Build et push de lâ€™image Docker
        run: |
          docker build -t ghcr.io/bouissai/bmarket:latest .
          
      - name: ğŸ§  Upload des sourcemaps Ã  Sentry
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ilyass-tb
          SENTRY_PROJECT: javascript-nextjs
          SENTRY_RELEASE: ${{ github.sha }}
        run: |
          echo "ğŸ” Upload des sourcemaps Ã  Sentry..."
          npx @sentry/cli sourcemaps upload \
            --auth-token "$SENTRY_AUTH_TOKEN" \
            --org "$SENTRY_ORG" \
            --project "$SENTRY_PROJECT" \
            --release "$SENTRY_RELEASE" \
            .next
      
      - name: ğŸ“¤ Push de l image sur GHCR
        run: |
          docker push ghcr.io/bouissai/bmarket:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Cloner le dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Installer Ansible
        run: sudo apt update && sudo apt install -y ansible

      - name: ğŸ”§ GÃ©nÃ©rer le fichier `hosts`
        run: |
          echo "[bmarket]" > hosts
          echo "${{ secrets.SERVER_IP }} ansible_user=deploy ansible_become=false" >> hosts
            
      - name: ğŸ”‘ Afficher la clÃ© privÃ©e (debug temporaire)
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | sed 's/./& /g'

      - name: ğŸ”‘ Configurer SSH pour Ansible
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
        env:
          SSH_AUTH_SOCK: /dev/null

      - name: ğŸ› Tester la connexion SSH
        run: ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa deploy@bmarket.fr hostname

      - name: ğŸ“¡ DÃ©ployer Bmarket avec Ansible
        run: ansible-playbook -i hosts .ansible/deploy.yml
        env:
          ANSIBLE_HOST_KEY_CHECKING: False
          SSH_AUTH_SOCK: /dev/null
