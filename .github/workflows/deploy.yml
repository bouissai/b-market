name: ðŸš€ Build, Push & Deploy to VPS with Ansible

on:
  push:
    branches:
      - master

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Cloner le dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ðŸ”‘ Se connecter Ã  GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin

      - name: ðŸ—ï¸ Build et push de lâ€™image Docker
        run: |
          docker build -t ghcr.io/bouissai/bmarket:latest .
          docker push ghcr.io/bouissai/bmarket:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Cloner le dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Installer Ansible
        run: sudo apt update && sudo apt install -y ansible

      - name: ðŸ”§ GÃ©nÃ©rer le fichier `hosts`
        run: |
          echo "[bmarket]" > hosts
          echo "${{ secrets.SERVER_IP }} ansible_user=deploy ansible_become=false" >> hosts

      - name: ðŸ“¡ DÃ©ployer Bmarket avec Ansible
        run: ansible-playbook -i hosts .ansible/deploy.yml
        env:
          ANSIBLE_HOST_KEY_CHECKING: False
