name: 🚀 Build, Push & Deploy with Ansible

on:
  push:
    branches:
      - master

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Installer Ansible sur GitHub Actions
        run: |
          sudo apt update
          sudo apt install -y ansible
          
      - name: 📥 Cloner le dépôt
        uses: actions/checkout@v4

      - name: 🔑 Se connecter à GitHub Container Registry (GHCR)
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin

      - name: 🏗️ Build de l'image Docker
        run: |
          docker build -t ghcr.io/bouissai/bmarket:latest .

      - name: 📤 Push de l'image sur GHCR
        run: |
          docker push ghcr.io/bouissai/bmarket:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Cloner le dépôt
        uses: actions/checkout@v4

      - name: 📡 Déployer avec Ansible
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: deploy
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            mkdir -p /home/deploy/ansible
            cd /home/deploy/ansible
            echo "[bmarket]" > hosts
            echo "${{ secrets.SERVER_IP }} ansible_user=deploy" >> hosts
            echo "${{ secrets.GHCR_USERNAME }}" > ghcr_user
            echo "${{ secrets.GHCR_TOKEN }}" > ghcr_token
            ansible-playbook -i hosts /home/deploy/bmarket/.ansible/deploy.yml
