name: ðŸš€ Build, Push & Deploy to VPS with Ansible

on:
  push:
    branches:
      - master

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Cloner le dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ðŸ”‘ Se connecter Ã  GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin

      - name: ðŸ—ï¸ Build et push de lâ€™image Docker
        run: |
          docker build -t ghcr.io/bouissai/bmarket:latest .
          
      - name: ðŸ§  Upload des sourcemaps Ã  Sentry
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ilyass-tb
          SENTRY_PROJECT: javascript-nextjs
          SENTRY_RELEASE: ${{ github.sha }}
        run: |
          echo "ðŸ” Upload des sourcemaps Ã  Sentry..."
          npx @sentry/cli sourcemaps upload \
            --auth-token "$SENTRY_AUTH_TOKEN" \
            --org "$SENTRY_ORG" \
            --project "$SENTRY_PROJECT" \
            --release "$SENTRY_RELEASE" \
            .next
      
      - name: ðŸ“¤ Push de l image sur GHCR
        run: |
          docker push ghcr.io/bouissai/bmarket:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Cloner le dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Installer Ansible
        run: sudo apt update && sudo apt install -y ansible

      - name: ðŸ”§ GÃ©nÃ©rer le fichier `hosts`
        run: |
          echo "[bmarket]" > hosts
          echo "${{ secrets.SERVER_IP }} ansible_user=deploy ansible_become=false" >> hosts

      - name: ðŸ“¡ DÃ©ployer Bmarket avec Ansible
        run: ansible-playbook -i hosts .ansible/deploy.yml
        env:
          ANSIBLE_HOST_KEY_CHECKING: False
          SSH_AUTH_SOCK: /dev/null

