- name: DÃ©ploiement complet de Bmarket
  hosts: bmarket
  become: true
  vars:
    ghcr_username: "{{ ghcr_username }}"
    ghcr_token: "{{ ghcr_token }}"
    domain_name: "{{ domain_name }}"
    postgres_user: "{{ lookup('env', 'POSTGRES_USER') }}"
    postgres_password: "{{ lookup('env', 'POSTGRES_PASSWORD') }}"
    postgres_db: "{{ lookup('env', 'POSTGRES_DB') }}"
    backup_dir: "/home/deploy/db_backups"

  tasks:

    # ğŸ“¦ Installer les dÃ©pendances
    - name: ğŸ“¦ Installer les paquets nÃ©cessaires
      apt:
        name:
          - docker.io
          - docker-compose
          - nginx
          - certbot
          - python3-certbot-nginx
          - ufw
          - fail2ban
          - postgresql
          - postgresql-contrib
        state: present
        update_cache: true

    # ğŸ”„ VÃ©rifier et dÃ©marrer PostgreSQL
    - name: ğŸ”„ VÃ©rifier si PostgreSQL est en cours d'exÃ©cution
      command: systemctl is-active postgresql
      register: pg_status
      changed_when: false
      ignore_errors: true

    - name: ğŸš€ DÃ©marrer PostgreSQL si nÃ©cessaire
      systemd:
        name: postgresql
        state: started
        enabled: true
      when: pg_status.stdout != "active"

    # ğŸ›¢ï¸ Configurer PostgreSQL pour les connexions externes
    - name: ğŸ”§ Modifier pg_hba.conf pour autoriser les connexions externes
      lineinfile:
        path: /etc/postgresql/15/main/pg_hba.conf
        line: "host all all 0.0.0.0/0 md5"
        create: yes
      notify: RedÃ©marrer PostgreSQL

    - name: ğŸ”§ Modifier postgresql.conf pour Ã©couter sur toutes les interfaces
      lineinfile:
        path: /etc/postgresql/16/main/postgresql.conf
        regexp: "^#listen_addresses = 'localhost'"
        line: "listen_addresses = '*'"
      notify: RedÃ©marrer PostgreSQL

    # ğŸ›¢ï¸ CrÃ©er l'utilisateur PostgreSQL
    - name: ğŸ›¢ï¸ VÃ©rifier si l'utilisateur PostgreSQL existe
      become_user: postgres
      command: psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='{{ postgres_user }}'"
      register: user_exists
      changed_when: false
      ignore_errors: true

    - name: ğŸ›¢ï¸ CrÃ©er l'utilisateur PostgreSQL si inexistant
      become_user: postgres
      postgresql_user:
        name: "{{ postgres_user }}"
        password: "{{ postgres_password }}"
        role_attr_flags: CREATEDB
      when: user_exists.stdout != "1"

    # ğŸ›¢ï¸ CrÃ©er la base de donnÃ©es PostgreSQL
    - name: ğŸ“‚ VÃ©rifier si la base de donnÃ©es existe
      become_user: postgres
      command: psql -tAc "SELECT 1 FROM pg_database WHERE datname='{{ postgres_db }}'"
      register: db_exists
      changed_when: false
      ignore_errors: true

    - name: ğŸ›¢ï¸ CrÃ©er la base de donnÃ©es si elle n'existe pas
      become_user: postgres
      postgresql_db:
        name: "{{ postgres_db }}"
        owner: "{{ postgres_user }}"
      when: db_exists.stdout != "1"

    # ğŸ“‚ Configurer un dossier de sauvegarde
    - name: ğŸ“‚ CrÃ©er un dossier pour stocker les backups
      file:
        path: "{{ backup_dir }}"
        state: directory
        owner: postgres
        group: postgres
        mode: "0700"

    # ğŸ›¢ï¸ Sauvegarde de la base de donnÃ©es avant chaque dÃ©ploiement
    - name: ğŸ›¢ï¸ Sauvegarde de la base de donnÃ©es
      become_user: postgres
      command: pg_dump -U {{ postgres_user }} -F c -b -v -f {{ backup_dir }}/bmarket_backup_$(date +%F_%H-%M-%S).dump {{ postgres_db }}
      ignore_errors: true

    # ğŸ”‘ Se connecter Ã  GitHub Container Registry (GHCR)
    - name: ğŸ”‘ Se connecter Ã  GHCR
      shell: echo "{{ ghcr_token }}" | docker login ghcr.io -u "{{ ghcr_username }}" --password-stdin

    # ğŸ“¦ TÃ©lÃ©charger l'image Docker
    - name: ğŸ“¦ TÃ©lÃ©charger la derniÃ¨re image Docker
      shell: docker pull ghcr.io/{{ ghcr_username }}/bmarket:latest

    # ğŸ›‘ ArrÃªter l'ancien conteneur
    - name: ğŸ›‘ ArrÃªter et supprimer l'ancien conteneur (si existant)
      shell: docker rm -f bmarket || true
    - name: ğŸš¨ VÃ©rification de DATABASE_URL avant le dÃ©ploiement
      debug:
        msg: "DATABASE_URL = postgresql://{{ postgres_user }}:{{ postgres_password }}@127.0.0.1:5432/{{ postgres_db }}"

    # ğŸš€ DÃ©marrer le conteneur avec PostgreSQL
    - name: ğŸš€ DÃ©marrer le conteneur
      shell: |
        docker run -d --name bmarket \
          -p 3000:3000 \
          -e DATABASE_URL="postgresql://{{ postgres_user }}:{{ postgres_password }}@127.0.0.1:5432/{{ postgres_db }}" \
          ghcr.io/{{ ghcr_username }}/bmarket:latest


    # ğŸ”„ Configurer Nginx comme reverse proxy
    - name: ğŸ”„ Configurer Nginx
      copy:
        dest: "/etc/nginx/sites-available/bmarket"
        content: |
          server {
              listen 80;
              server_name {{ domain_name }} www.{{ domain_name }};

              location / {
                  proxy_pass http://localhost:3000;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
          }

    - name: ğŸ”— Activer la configuration Nginx
      file:
        src: "/etc/nginx/sites-available/bmarket"
        dest: "/etc/nginx/sites-enabled/bmarket"
        state: link

    - name: ğŸ§¹ Supprimer la configuration Nginx par dÃ©faut
      file:
        path: "/etc/nginx/sites-enabled/default"
        state: absent

    - name: ğŸ”„ RedÃ©marrer Nginx
      systemd:
        name: nginx
        state: restarted
        enabled: true

    # ğŸ”’ GÃ©nÃ©rer un certificat SSL avec Let's Encrypt
    - name: ğŸ”’ GÃ©nÃ©rer un certificat SSL avec Certbot
      shell: certbot --nginx -d {{ domain_name }} -d www.{{ domain_name }} --non-interactive --agree-tos -m contact@{{ domain_name }}

    - name: ğŸ”„ RedÃ©marrer Nginx aprÃ¨s Certbot
      systemd:
        name: nginx
        state: restarted

  handlers:
    - name: RedÃ©marrer PostgreSQL
      systemd:
        name: postgresql
        state: restarted
