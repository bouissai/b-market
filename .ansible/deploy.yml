- name: DÃ©ploiement complet de Bmarket
  hosts: bmarket
  become: true
  vars:
    ghcr_username: "{{ ghcr_username }}"
    ghcr_token: "{{ ghcr_token }}"
    domain_name: "{{ domain_name }}"
    postgres_user: "{{ lookup('env', 'POSTGRES_USER') }}"
    postgres_password: "{{ lookup('env', 'POSTGRES_PASSWORD') }}"
    postgres_db: "{{ lookup('env', 'POSTGRES_DB') }}"
    backup_dir: "/home/deploy/db_backups"

  tasks:

    # ğŸ“Œ Affichage des variables pour le debug
    - name: ğŸ› Afficher les valeurs des variables
      debug:
        msg:
          - "PostgreSQL User: {{ postgres_user }}"
          - "PostgreSQL Password: {{ postgres_password }}"
          - "PostgreSQL DB: {{ postgres_db }}"
          - "GHCR Username: {{ ghcr_username }}"
          - "GHCR Token: {{ ghcr_token }}"
          - "Domain Name: {{ domain_name }}"
          - "Backup Directory: {{ backup_dir }}"

    # ğŸ“¦ Installer les dÃ©pendances
    - name: ğŸ“¦ Installer les paquets nÃ©cessaires
      apt:
        name:
          - docker.io
          - docker-compose
          - nginx
          - certbot
          - python3-certbot-nginx
          - ufw
          - fail2ban
          - postgresql
          - postgresql-contrib
        state: present
        update_cache: true

    # ğŸ”„ VÃ©rifier et dÃ©marrer PostgreSQL
    - name: ğŸ”„ VÃ©rifier si PostgreSQL est en cours d'exÃ©cution
      command: systemctl is-active postgresql
      register: pg_status
      changed_when: false
      ignore_errors: true

    - name: ğŸš€ Afficher l'Ã©tat de PostgreSQL
      debug:
        msg: "Ã‰tat actuel de PostgreSQL : {{ pg_status.stdout }}"

    - name: ğŸš€ DÃ©marrer PostgreSQL si nÃ©cessaire
      systemd:
        name: postgresql
        state: started
        enabled: true
      when: pg_status.stdout != "active"
    
    - name: Debug PostgreSQL User
      debug:
        msg: "PostgreSQL User: {{ postgres_user }}, Password: {{ postgres_password }}"

    - name: ğŸ”¥ Supprimer l'utilisateur PostgreSQL s'il existe
      become_user: postgres
      command: psql -c "DROP USER IF EXISTS {{ postgres_user }};"
      ignore_errors: true

    - name: ğŸ›¢ï¸ VÃ©rifier si l'utilisateur PostgreSQL existe
      become_user: postgres
      command: psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='{{ postgres_user }}'"
      register: user_exists
      changed_when: false
      ignore_errors: true

    - name: ğŸ›¢ï¸ CrÃ©er l'utilisateur PostgreSQL
      become_user: postgres
      command: psql -c "CREATE USER {{ postgres_user }} WITH PASSWORD '{{ postgres_password }}'; ALTER USER {{ postgres_user }} CREATEDB;"
      when: user_exists.stdout != "1"
      register: create_user_result
      ignore_errors: true


    # ğŸ“‚ VÃ©rifier l'existence de la base de donnÃ©es
    - name: ğŸ“‚ VÃ©rifier si la base de donnÃ©es existe
      become_user: postgres
      command: psql -tAc "SELECT 1 FROM pg_database WHERE datname='{{ postgres_db }}'"
      register: db_exists
      changed_when: false
      ignore_errors: true

    - name: ğŸ›¢ï¸ Afficher le statut de la base de donnÃ©es PostgreSQL
      debug:
        msg: "RÃ©sultat de la vÃ©rification de la base de donnÃ©es PostgreSQL : {{ db_exists.stdout }}"

    # ğŸ›¢ï¸ CrÃ©er la base de donnÃ©es si elle n'existe pas
    - name: ğŸ›¢ï¸ CrÃ©er la base de donnÃ©es PostgreSQL
      become_user: postgres
      command: psql -c "CREATE DATABASE {{ postgres_db }} OWNER {{ postgres_user }}"
      when: db_exists.stdout != "1"
      register: create_db_result

    - name: ğŸ›¢ï¸ Afficher le rÃ©sultat de la crÃ©ation de la base de donnÃ©es
      debug:
        msg: "CrÃ©ation de la base de donnÃ©es PostgreSQL : {{ create_db_result.stderr if create_db_result.stderr else 'SuccÃ¨s' }}"

    # ğŸ”‘ Se connecter Ã  GitHub Container Registry (GHCR)
    - name: ğŸ”‘ Se connecter Ã  GHCR
      shell: |
        set -x
        echo "{{ ghcr_token }}" | docker login ghcr.io -u "{{ ghcr_username }}" --password-stdin
      register: ghcr_login_result
      ignore_errors: true

    - name: ğŸ”‘ Afficher le rÃ©sultat de la connexion Ã  GHCR
      debug:
        msg: "Connexion Ã  GHCR : {{ ghcr_login_result.stderr if ghcr_login_result.stderr else 'SuccÃ¨s' }}"

    # ğŸ“¦ TÃ©lÃ©charger l'image Docker
    - name: ğŸ“¦ TÃ©lÃ©charger la derniÃ¨re image Docker
      shell: docker pull ghcr.io/{{ ghcr_username }}/bmarket:latest
      register: docker_pull_result
      ignore_errors: true

    - name: ğŸ“¦ Afficher le rÃ©sultat du tÃ©lÃ©chargement de l'image Docker
      debug:
        msg: "TÃ©lÃ©chargement de l'image Docker : {{ docker_pull_result.stderr if docker_pull_result.stderr else 'SuccÃ¨s' }}"

    # ğŸ›‘ ArrÃªter l'ancien conteneur
    - name: ğŸ›‘ ArrÃªter et supprimer l'ancien conteneur (si existant)
      shell: docker rm -f bmarket || true

    - name: ğŸš¨ VÃ©rification de DATABASE_URL avant le dÃ©ploiement
      debug:
        msg: "DATABASE_URL = postgresql://{{ postgres_user }}:{{ postgres_password }}@127.0.0.1:5432/{{ postgres_db }}"

    # ğŸš€ DÃ©marrer le conteneur avec PostgreSQL
    - name: ğŸš€ DÃ©marrer le conteneur Docker
      shell: |
        set -x
        docker run -d --name bmarket \
          -p 3000:3000 \
          -e DATABASE_URL="postgresql://{{ postgres_user }}:{{ postgres_password }}@127.0.0.1:5432/{{ postgres_db }}" \
          ghcr.io/{{ ghcr_username }}/bmarket:latest
      register: docker_run_result
      ignore_errors: true

    - name: ğŸš€ Afficher le rÃ©sultat du dÃ©marrage du conteneur Docker
      debug:
        msg: "DÃ©marrage du conteneur Docker : {{ docker_run_result.stderr if docker_run_result.stderr else 'SuccÃ¨s' }}"

  handlers:
    - name: RedÃ©marrer PostgreSQL
      systemd:
        name: postgresql
        state: restarted
