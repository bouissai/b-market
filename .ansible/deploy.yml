---
- name: DÃ©ploiement de Bmarket sur VPS
  hosts: bmarket
  become: true  # ExÃ©cute les commandes avec sudo
  vars:
    ghcr_username: "{{ lookup('env', 'GHCR_USERNAME') }}"
    ghcr_token: "{{ lookup('env', 'GHCR_TOKEN') }}"
  tasks:

    - name: ğŸ—ï¸ Mettre Ã  jour les paquets
      apt:
        update_cache: yes

    - name: ğŸ“¦ Installer Docker et Docker Compose
      apt:
        name: ["docker.io", "docker-compose"]
        state: present

    - name: ğŸ—ï¸ VÃ©rifier si lâ€™utilisateur deploy existe
      command: id deploy
      register: deploy_user
      ignore_errors: yes

    - name: ğŸ‘¤ CrÃ©er l'utilisateur deploy s'il n'existe pas
      user:
        name: deploy
        groups: docker
        shell: /bin/bash
      when: deploy_user.rc != 0

    - name: ğŸ”‘ Autoriser deploy Ã  exÃ©cuter sudo sans mot de passe
      copy:
        dest: /etc/sudoers.d/deploy
        content: "deploy ALL=(ALL) NOPASSWD:ALL"
        mode: "0440"

    - name: ğŸ“‚ S'assurer que le dossier de dÃ©ploiement existe
      file:
        path: /home/deploy/bmarket
        state: directory
        owner: deploy
        group: deploy
        mode: '0755'

    - name: ğŸ“ GÃ©nÃ©rer le fichier docker-compose.yml
      copy:
        dest: /home/deploy/bmarket/docker-compose.yml
        content: |
          version: '3.9'
          services:
            app:
              image: ghcr.io/bouissai/bmarket:latest
              container_name: bmarket
              restart: always
              ports:
                - "3000:3000"
              env_file:
                - .env
        owner: deploy
        group: deploy
        mode: '0644'

    - name: ğŸ”‘ Se connecter Ã  GHCR
      command: docker login ghcr.io -u {{ ghcr_username }} -p {{ ghcr_token }}

    - name: ğŸ“¥ RÃ©cupÃ©rer la derniÃ¨re image Docker
      command: docker-compose pull
      args:
        chdir: /home/deploy/bmarket

    - name: ğŸ›‘ ArrÃªter et supprimer lâ€™ancien conteneur
      command: docker-compose down
      args:
        chdir: /home/deploy/bmarket
      ignore_errors: yes

    - name: ğŸš€ DÃ©marrer les nouveaux conteneurs
      command: docker-compose up -d
      args:
        chdir: /home/deploy/bmarket
